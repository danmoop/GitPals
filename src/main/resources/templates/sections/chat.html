<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.springframework.org/schema/mvc">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.umd.min.js"></script>
    <script src="/js/jquery.js"></script>
</head>
<body>


<h2>Hello to GitPals Chat, <b><u>[[${user.username}]]</u></b></h2>

<div id="main-content" class="container">
    <div class="row">
        <div class="col-md-6">
            <form class="form-inline">
                <div class="form-group">
                    <input type="text" id="content" class="form-control" placeholder="Message">
                    <button id="send">Send</button>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table id="conversation" class="table table-striped">
                <tbody id="greetings">
                </tbody>
            </table>
        </div>
    </div>
</div>


<script th:inline="javascript">

        var stompClient = null;

        function connect() {
            var socket = new SockJS('/gitpals-messages');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/greetings', function (greeting) {
                    console.log(JSON.parse(greeting.body));
                    showGreeting(JSON.parse(greeting.body));
                });
            });
        }

        function sendContent() {
            stompClient.send("/app/hello", {}, JSON.stringify({'author': [[${user.username}]], 'content':$("#content").val()}));
            $("#content").val("");
        }

        function showGreeting(body) {
            $("#greetings").append("<h2>" + body.author + ": " + body.content + "</h2>");
        }

        $(function () {
            $("form").on('submit', function (e) {
                e.preventDefault();
            });
            $( "#send" ).click(function() { sendContent(); });
            connect();
        });
    </script>
</body>
</html>